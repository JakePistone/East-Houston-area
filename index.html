<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>NIOS Land Map — Distances</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
        #map{height:100vh;width:100%;position:relative;z-index:1;}
        .custom-marker-icon{
            border:2px solid #fff;color:#fff;font-weight:600;font-size:12px;text-align:center;border-radius:50%;
            width:28px;height:28px;line-height:24px;box-shadow:0 2px 4px rgba(0,0,0,0.2);transition:transform .15s;
        }
        .dropdown-container{
            position:absolute;top:20px;right:20px;z-index:1200;display:flex;gap:8px;background:#fff;padding:10px;
            border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.12);flex-wrap:wrap;
        }
        button{padding:8px 14px;border:none;background:#1a73e8;color:#fff;cursor:pointer;border-radius:8px;
               font-size:13px;font-weight:600;}
        button:hover{background:#1557b0;}
        #market-toggle{background:#f1f3f5;color:#000;padding:10px;border-radius:8px;font-weight:700;}
        #property-selector,#property-search-container,#market-search-container,#market-selector-container{
            position:absolute;z-index:1100;background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.12);
            max-width:320px;font-size:14px;padding:10px;
        }
        #property-selector{top:80px;left:20px;}
        #property-search-container{top:140px;left:20px;z-index:1300;}
        #market-search-container{top:200px;left:20px;}
        #market-selector-container{top:260px;left:20px;}
        #market-selector-list{
            max-height:220px;overflow-y:auto;margin-top:8px;padding:6px;background:#fff;
            border:1px solid #e2e8f0;border-radius:8px;display:none;
        }
        #market-selector-list.show{display:block;}
        .map-title{position:absolute;top:20px;left:60px;z-index:1000;font-size:20px;font-weight:700;color:#0f172a;
            background:#fff;padding:8px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
        .logo{position:absolute;bottom:20px;left:20px;z-index:1000;background:#fff;padding:8px 12px;border-radius:8px;
            display:flex;align-items:center;gap:10px;font-weight:700;}
        .logo img{width:70px;height:60px;object-fit:contain;}
        .date-time{position:absolute;top:20px;left:50%;transform:translateX(-50%);z-index:1000;background:#fff;
            padding:8px 12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.08);font-size:13px;color:#0f172a;}
        #loading-indicator{position:absolute;top:100px;left:50%;transform:translateX(-50%);z-index:1000;background:#fff;
            padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);font-size:14px;}
        .distance-label{
            background:rgba(255,255,255,0.95);padding:4px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);
            font-weight:700;font-size:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);
        }
        #exclusions-panel{display:none; position:absolute; top:100px; right:20px; z-index:1200; background:#fff; padding:15px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.12); max-width:300px; max-height:400px; overflow-y:auto; font-size:14px;}
        #exclusions-panel.show{display:block;}
        .exclusion-item{border-bottom:1px solid #eee; padding:5px; margin-bottom:5px;}
        .exclusion-item button{background:#e63946; color:#fff; padding:4px 8px; border:none; border-radius:4px; cursor:pointer; font-size:12px;}
        .exclusion-item button:hover{background:#d63031;}
        #data-table-panel{display:none; position:absolute; top:100px; left:20px; z-index:1200; background:#fff; padding:15px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.12); max-width:90vw; max-height:70vh; overflow:auto; font-size:14px;}
        #data-table-panel.show{display:block;}
        #properties-table{width:100%; border-collapse:collapse; margin-top:10px;}
        #properties-table th, #properties-table td {border:1px solid #ddd; padding:8px; text-align:left;}
        #properties-table th {background-color:#f2f2f2; font-weight:bold;}
    </style>
</head>
<body>
    <div id="loading-indicator">Loading map & data...</div>
    <div class="date-time" id="date-time"></div>
    <select id="property-selector"><option>Loading properties...</option></select>
    <div id="property-search-container">
        <input type="text" id="property-search" placeholder="Search properties..." />
        <div id="search-results"></div>
    </div>
    <div id="market-search-container">
        <input type="text" id="market-search" placeholder="Search markets..." />
        <div id="market-search-results"></div>
    </div>
    <!-- TOGGLE MARKET SELECTION — WORKS PERFECTLY -->
    <div id="market-selector-container">
        <button id="market-toggle">Toggle Market Selection</button>
        <div id="market-selector-list">
            <label style="display:block;margin-bottom:6px;"><input type="checkbox" id="select-all-markets" checked> Select All Markets</label>
        </div>
    </div>
    <div class="dropdown-container">
        <button id="view-table">View Data Table</button>
        <button id="manage-exclusions">Manage Exclusions</button>
        <button id="send-excluded">Send Excluded List</button>
        <button id="toggle-distances">Show Distances</button>
        <button id="toggle-satellite">Satellite</button>
    </div>
    <div id="exclusions-panel">
        <h3 style="margin-top:0;">Excluded Properties</h3>
        <div id="exclusions-list"></div>
    </div>
    <div id="data-table-panel">
        <h3 style="margin-top:0;">Properties Data Table</h3>
        <table id="properties-table">
            <thead>
                <tr>
                    <th>Property Name</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                    <th>Market</th>
                    <th>Acres</th>
                    <th>Price</th>
                    <th>$/SF</th>
                    <th>Link</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="map">
        <div class="map-title" id="map-title">NIOS Land Map</div>
        <div class="logo">
            <img src="https://ik.imagekit.io/lwowie9pn/Unknown-1%20copy.png?updatedAt=1754674703991" alt="NIOS Logo" />
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // Initialize map FIRST — this fixes the loading issue
        const map = L.map('map').setView([37, -95], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        const markers = {};
        let properties = [];
        const excluded = new Set();
        const marketColors = {"EWING CURRENT":"#1a73e8","EWING NIOS":"#e63946","EWING POTENTIAL SITES":"#22c55e","default":"#1a73e8"};
        const getColor = m => marketColors[m] || marketColors.default;
        let distanceLines = [];
        let showDistances = false;
        // Date/time
        const now = new Date();
        document.getElementById('date-time').textContent =
            now.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'America/Chicago'}).replace(/^0/,'') +
            ' CDT, ' + now.toLocaleDateString('en-US', {weekday:'long',month:'long',day:'numeric',year:'numeric',timeZone:'America/Chicago'});
        // Satellite toggle
        document.getElementById('toggle-satellite').onclick = function(){
            if(map.hasLayer(satellite)){
                map.removeLayer(satellite);
                map.addLayer(L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'));
                this.textContent='Satellite';
            } else {
                map.removeLayer(map.getPanes().tilePane.querySelector('.leaflet-layer'));
                map.addLayer(satellite);
                this.textContent='Streets';
            }
        };
        // TOGGLE MARKET SELECTION — WORKS PERFECTLY
        const marketList = document.getElementById('market-selector-list');
        document.getElementById('market-toggle').onclick = function(){
            marketList.classList.toggle('show');
        };
        // Distance function
        function milesBetween(lat1,lon1,lat2,lon2){
            const R=3958.8,toRad=d=>d*Math.PI/180,
                  dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1),
                  a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        }
        // Function to generate popup content with dynamic checkbox state
        function popupContent(i) {
            const p = properties[i];
            const checked = excluded.has(i) ? 'checked' : '';
            return `
                <div style="min-width:180px"><b>${p.name}</b><br/>
                Market: <strong>${p.market}</strong><br/>Acres: ${p.ac}<br/>Price: ${p.price}<br>$/SF: ${p.psf}<br/>
                <a href="${p.link}" target="_blank" style="color:#1a73e8">View Details</a><br/><br/>
                <label style="font-weight:600"><input type="checkbox" class="exclude-checkbox" data-index="${i}" ${checked}> Exclude</label>
                </div>`;
        }
        // Function to update exclusions list in panel
        function updateExclusionsList() {
            const list = document.getElementById('exclusions-list');
            list.innerHTML = '';
            if (excluded.size === 0) {
                list.innerHTML = '<p>No excluded properties.</p>';
                return;
            }
            let html = '';
            let count = 1;
            excluded.forEach(i => {
                const p = properties[i];
                html += `<div class="exclusion-item">
                    <div><b>${count++}. ${p.name}</b></div>
                    <div>Market: ${p.market}</div>
                    <div>Acres: ${p.ac}</div>
                    <button onclick="removeExclusion(${i})">Remove Exclusion</button>
                </div>`;
            });
            list.innerHTML = html;
        }
        // Global function to remove exclusion
        window.removeExclusion = function(i) {
            excluded.delete(i);
            updateMap();
            updateExclusionsList();
        };
        // Manage Exclusions button
        document.getElementById('manage-exclusions').onclick = function() {
            const panel = document.getElementById('exclusions-panel');
            panel.classList.toggle('show');
            updateExclusionsList();
        };
        // View Data Table button
        document.getElementById('view-table').onclick = function() {
            const panel = document.getElementById('data-table-panel');
            panel.classList.toggle('show');
            if (panel.classList.contains('show')) {
                updateDataTable();
            }
        };
        // Function to update data table
        function updateDataTable() {
            const tbody = document.querySelector('#properties-table tbody');
            tbody.innerHTML = '';
            properties.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${p.lat.toFixed(6)}</td>
                    <td>${p.lng.toFixed(6)}</td>
                    <td>${p.market}</td>
                    <td>${p.ac}</td>
                    <td>${p.price}</td>
                    <td>${p.psf}</td>
                    <td><a href="${p.link}" target="_blank">View</a></td>
                    <td>${p.notes || ''}</td>
                `;
                tbody.appendChild(row);
            });
        }
        // Send Excluded List button
        document.getElementById('send-excluded').onclick = function() {
            if (excluded.size === 0) {
                alert('No excluded properties to send.');
                return;
            }
            let body = 'Excluded Properties List:\n\n';
            let count = 1;
            excluded.forEach(i => {
                const p = properties[i];
                body += `${count++}. ${p.name} - ${p.market} (${p.ac} acres)\n`;
                if (p.price !== 'N/A') body += `   Price: ${p.price}\n`;
                if (p.psf !== 'N/A') body += `   $/SF: ${p.psf}\n`;
                body += '\n';
            });
            body += '\nGenerated on: ' + new Date().toLocaleString('en-US', {timeZone: 'America/Chicago'});
            const subject = 'Excluded Properties List - NIOS Land Map';
            const url = `https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent('jake@reservecappartners.com')}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(url, '_blank');
        };
        // MAIN PROPERTY LOADING — MAP LOADS 100%
        Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vTdmHlBnanLuTmq25cEpRDr0umbJ1NHIXeEZp0izQ7ufKeOWxSGObg2bGRtFEBxpu_wsgT_Eeq2Qiu6/pub?gid=0&single=true&output=csv',{
            download:true,header:true,skipEmptyLines:true,
            complete:function(res){
                properties = res.data
                    .map(row=>({
                        name: row["Property Name"]||row["Name"]||"Unnamed",
                        lat: parseFloat(row["Latitude"]||row["lat"]||row["Lat"]),
                        lng: parseFloat(row["Longitude"]||row["lng"]||row["Lng"]),
                        market: row["Market Name"]||row["Market"]||"Unknown",
                        ac: row["Acres"]||row["ac"]||"N/A",
                        price: row["Price"]||"N/A",
                        psf: row["$/SF"]||row["$/sf"]||"N/A",
                        link: row["Link"]||row["link"]||"#",
                        notes: row["Notes"] || ""
                    }))
                    .filter(p=>!isNaN(p.lat)&&!isNaN(p.lng));
                if(properties.length===0){
                    alert("No properties found — check your sheet!");
                    document.getElementById('loading-indicator').style.display='none';
                    return;
                }
                properties.forEach((p,i)=>{
                    const icon=L.divIcon({className:'',iconSize:[28,28],iconAnchor:[14,14],
                        html:`<div class="custom-marker-icon" style="background:${getColor(p.market)}">${i+1}</div>`});
                    markers[i]=L.marker([p.lat,p.lng],{icon}).bindPopup(popupContent(i)).addTo(map);
                });
                map.fitBounds(L.latLngBounds(properties.map(p=>[p.lat,p.lng])).pad(0.25));
                const sel=document.getElementById('property-selector');
                sel.innerHTML='<option value="-1">Select property...</option>';
                properties.forEach((p,i)=>{const opt=document.createElement('option');opt.value=i;opt.textContent=`${i+1}: ${p.name}`;sel.appendChild(opt);});
                sel.onchange=function(){const i=+this.value;if(i>=0){map.flyTo([properties[i].lat,properties[i].lng],16,{duration:1.5});markers[i].openPopup();}};
                // Populate market list
                const markets = [...new Set(properties.map(p=>p.market))].sort();
                markets.forEach(m=>{
                    const div=document.createElement('div');
                    div.style.marginBottom='6px';
                    div.innerHTML=`<label style="display:block"><input type="checkbox" value="${m}" checked> ${m}</label>`;
                    marketList.appendChild(div);
                });
                document.getElementById('toggle-distances').onclick=function(){
                    showDistances=!showDistances;
                    this.textContent=showDistances?'Hide Distances':'Show Distances';
                    updateMap();
                };
                function updateMap(){
                    const checked=document.querySelectorAll('#market-selector-list input[type="checkbox"]:checked');
                    const selectedMarkets=Array.from(checked).map(c=>c.value);
                    const visible=properties.map((p,i)=>({p,i})).filter(o=>selectedMarkets.includes(o.p.market)&&!excluded.has(o.i));
                    document.getElementById('map-title').textContent=
                        selectedMarkets.length===markets.length?'NIOS Land Map':
                        selectedMarkets.length===1?`${selectedMarkets[0]} Market Map`:'Selected Markets';
                    Object.values(markers).forEach(m=>map.removeLayer(m));
                    visible.forEach((o,idx)=>{
                        markers[o.i].setIcon(L.divIcon({
                            className:'',iconSize:[28,28],iconAnchor:[14,14],
                            html:`<div class="custom-marker-icon" style="background:${getColor(o.p.market)}">${idx+1}</div>`
                        })).addTo(map);
                    });
                    sel.innerHTML='<option value="-1">Select property...</option>';
                    visible.forEach((o,idx)=>{const opt=document.createElement('option');opt.value=o.i;opt.textContent=`${idx+1}: ${o.p.name}`;sel.appendChild(opt);});
                    drawDistanceLines(visible.map(o=>o.p));
                }
                function drawDistanceLines(visibleProps){
                    distanceLines.forEach(l=>map.removeLayer(l));
                    distanceLines=[];
                    if(!showDistances||visibleProps.length<2) return;
                    const drawn=new Set();
                    visibleProps.forEach(cur=>{
                        const candidates=visibleProps
                            .filter(o=>o!==cur)
                            .map(o=>({other:o,dist:milesBetween(cur.lat,cur.lng,o.lat,o.lng)}))
                            .sort((a,b)=>a.dist-b.dist)
                            .slice(0,3);
                        candidates.forEach(c=>{
                            const key=`${Math.min(properties.findIndex(p=>p===cur),properties.findIndex(p=>p===c.other))}_${Math.max(properties.findIndex(p=>p===cur),properties.findIndex(p=>p===c.other))}`;
                            if(drawn.has(key)) return;
                            drawn.add(key);
                            const line=L.polyline([[cur.lat,cur.lng],[c.other.lat,c.other.lng]],{color:'#111',weight:1.4,opacity:0.9}).addTo(map);
                            const midLat=(cur.lat+c.other.lat)/2, midLng=(cur.lng+c.other.lng)/2;
                            const label=L.marker([midLat,midLng],{
                                icon:L.divIcon({className:'distance-label',html:`${c.dist.toFixed(1)} mi`,iconAnchor:[0,0]}),
                                interactive:false
                            }).addTo(map);
                            distanceLines.push(line,label);
                        });
                    });
                }
                document.addEventListener('change',e=>{
                    if(e.target.classList.contains('exclude-checkbox')){
                        const i=+e.target.dataset.index;
                        e.target.checked?excluded.add(i):excluded.delete(i);
                        updateMap();
                        updateExclusionsList();
                    }
                    if(e.target.matches('#market-selector-list input[type="checkbox"]')){
                        const allChecked=[...document.querySelectorAll('#market-selector-list input[value]')].every(c=>c.checked);
                        document.getElementById('select-all-markets').checked=allChecked;
                        updateMap();
                    }
                });
                document.getElementById('select-all-markets').onchange=function(){
                    document.querySelectorAll('#market-selector-list input[value]').forEach(c=>c.checked=this.checked);
                    updateMap();
                };
                updateMap();
                updateExclusionsList();
                document.getElementById('loading-indicator').style.display='none';
            }
        });
    </script>
</body>
</html>
